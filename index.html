<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Cloud Notepad v6.0</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        * { box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background-color: #f2f2f7; margin: 0; display: flex; justify-content: center; min-height: 100vh; }
        .hidden { display: none !important; }
        
        /* Auth UI */
        #authContainer { width: 100%; max-width: 340px; padding: 40px 20px; text-align: center; }
        .auth-box { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; margin-bottom: 15px; font-size: 16px; }
        .password-wrapper { position: relative; width: 100%; }
        .toggle-password { position: absolute; right: 10px; top: 12px; background: none; border: none; cursor: pointer; color: #8e8e93; }

        /* App UI */
        #appContainer { width: 100%; max-width: 500px; padding: 15px; }
        .editor-container { background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden; margin-bottom: 20px; border: 1px solid #e5e5ea; }
        .toolbar { background: #f8f8f8; padding: 10px; border-bottom: 1px solid #eee; display: flex; gap: 5px; flex-wrap: wrap; }
        .toolbar button, .toolbar select { background: white; border: 1px solid #ddd; padding: 6px 8px; border-radius: 6px; cursor: pointer; font-size: 13px; }
        
        /* ÁºñËæëÂô®Ê†∏ÂøÉ CSS */
        #editor { 
            --placeholder-size: 16px;
            min-height: 200px; 
            padding: 15px; 
            outline: none; 
            font-size: 16px; /* ÈªòËÆ§Âü∫ÂáÜ */
            line-height: 1.4; 
            word-wrap: break-word;
        }

        /* ÊèêÁ§∫ËØçÈöèÁùÄÂèòÈáèÂêåÊ≠• */
        #editor:empty:before { 
            content: attr(placeholder); 
            color: #999; 
            font-size: var(--placeholder-size); 
            display: inline-block;
        }

        .btn-primary { width: 100%; padding: 14px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; background-color: #007aff; color: white; font-size: 16px; }
        .note-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #efeff4; position: relative; }
    </style>
</head>
<body>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBdWwwAQKf2WVABXqmOEyL2jVQeQXkvg1o",
            authDomain: "web-notepad-1c001.firebaseapp.com",
            databaseURL: "https://web-notepad-1c001-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "web-notepad-1c001",
            storageBucket: "web-notepad-1c001.firebasestorage.app",
            messagingSenderId: "592119278975",
            appId: "1:592119278975:web:0dd2c5a3f46bb6b88efe4a"
        };
        firebase.initializeApp(firebaseConfig);
    </script>

    <div id="authContainer">
        <div class="auth-box">
            <h2 id="authTitle">Sign In</h2>
            <input type="email" id="email" placeholder="Email">
            <div class="password-wrapper">
                <input type="password" id="password" placeholder="Password">
                <button type="button" class="toggle-password" onclick="togglePasswordVisibility()">üëÅ</button>
            </div>
            <button class="btn-primary" style="margin-top:15px" onclick="handleAuth()">Go</button>
            <button style="background:none; color:#007aff; font-size:13px; margin-top:15px; border:none;" onclick="toggleAuthMode()">Toggle Mode</button>
        </div>
    </div>

    <div id="appContainer" class="hidden">
        <div class="editor-container">
            <div class="toolbar">
                <select id="fontSizeSelect" onchange="applyFontSize(this.value)">
                    <option value="10px">XS</option>
                    <option value="13px">S</option>
                    <option value="16px" selected>M</option>
                    <option value="18px">L</option>
                    <option value="24px">XL</option>
                    <option value="32px">XXL</option>
                    <option value="48px">MAX</option>
                </select>
                <button onclick="applyFormat('bold')">B</button>
                <button onclick="applyFormat('italic')">I</button>
            </div>
            <div id="editor" contenteditable="true" placeholder="Tap here to write..." 
                 onkeyup="syncContext()" 
                 onmouseup="syncContext()" 
                 onclick="syncContext()"></div>
        </div>
        <button class="btn-primary" onclick="saveNote()">Save Note</button>
        <div id="notesList" style="margin-top: 20px;"></div>
    </div>

    <script>
        const auth = firebase.auth();
        const db = firebase.database();
        let currentUser = null;
        let isSignUpMode = false;

        // --- Ê†∏ÂøÉÈÄªËæë 1ÔºöÂ∫îÁî®Â≠óÂè∑ÔºàÂÖâÊ†áÁ´ãÂç≥ÂèòÂ§ßÔºâ ---
        function applyFontSize(pxSize) {
            const editor = document.getElementById('editor');
            editor.focus();

            // ÂêåÊ≠• Placeholder Â§ßÂ∞è
            editor.style.setProperty('--placeholder-size', pxSize);

            // Â¶ÇÊûúÁºñËæëÂô®ÊòØÁ©∫ÁöÑÔºåÁõ¥Êé•‰øÆÊîπÂÆπÂô®Â≠óÂè∑ÔºåÂÖâÊ†á‰ºöÁ´ãÂç≥ÂèòÂ§ß
            if (editor.innerText.trim() === "") {
                editor.style.fontSize = pxSize;
            }

            // [Ê†∏ÂøÉÈªëÁßëÊäÄ]ÔºöÊèíÂÖ•‰∏Ä‰∏™Â∏¶Ê†∑ÂºèÁöÑÁ©∫ span
            // Áõ∏ÊØî‰πãÂâçÁöÑÈõ∂ÂÆΩÁ©∫Ê†ºÔºåÊàë‰ª¨Áõ¥Êé•Âú®ÂΩìÂâç‰ΩçÁΩÆÊèíÂÖ•‰∏Ä‰∏™ span Âπ∂ÊääÂÖâÊ†áÊîæÂÖ•ÂÖ∂‰∏≠
            // ËøôÊ†∑ÂÖâÊ†áÁöÑÈ´òÂ∫¶‰ºöÁ´ãÂç≥Ë¢´ span ÁöÑ line-height ÊíëÂ§ß
            const sel = window.getSelection();
            if (sel.rangeCount) {
                const range = sel.getRangeAt(0);
                range.deleteContents();

                const span = document.createElement("span");
                span.style.fontSize = pxSize;
                // Âä†ÂÖ•Èõ∂ÂÆΩÁ©∫Ê†ºÁ°Æ‰øù span Ë¢´Ê∏≤Êüì
                span.appendChild(document.createTextNode('\u200B'));
                
                range.insertNode(span);

                // Â∞ÜÂÖâÊ†áÁßªÂÖ•Ëøô‰∏™ span ‰πãÂêé
                const newRange = document.createRange();
                newRange.setStart(span, 1); 
                newRange.collapse(true);
                sel.removeAllRanges();
                sel.addRange(newRange);
            }
        }

        // --- Ê†∏ÂøÉÈÄªËæë 2Ôºö‰∏ä‰∏ãÊñáÂêåÊ≠•ÔºàÁÇπÂáªÂì™ÔºåÂ∑•ÂÖ∑Ê†èÂèòÂì™Ôºâ ---
        function syncContext() {
            const editor = document.getElementById('editor');
            const select = document.getElementById('fontSizeSelect');
            const sel = window.getSelection();

            if (sel.rangeCount > 0) {
                const range = sel.getRangeAt(0);
                let container = range.startContainer;

                // Â¶ÇÊûúÁÇπÂú®ÊñáÊú¨‰∏äÔºåÊâæÂÆÉÁöÑÁà∂ÂÖÉÁ¥†ËØªÂèñÊ†∑Âºè
                if (container.nodeType === 3) {
                    container = container.parentNode;
                }

                // Ëé∑ÂèñÂÆûÈôÖËÆ°ÁÆóÂá∫Êù•ÁöÑÂ≠óÂè∑Ôºà‰æãÂ¶Ç "24px"Ôºâ
                const computedSize = window.getComputedStyle(container).fontSize;
                
                // Êõ¥Êñ∞‰∏ãÊãâËèúÂçï
                // Êàë‰ª¨ÈúÄË¶ÅÊääËÆ°ÁÆóÂá∫ÁöÑ "23.98px" ËøôÁßçÂÄºÂåπÈÖçÂà∞ÊúÄÊé•ËøëÁöÑÈÄâÈ°π
                const options = Array.from(select.options);
                let bestMatch = options[0].value;
                let minDiff = Infinity;

                options.forEach(opt => {
                    const diff = Math.abs(parseFloat(opt.value) - parseFloat(computedSize));
                    if (diff < minDiff) {
                        minDiff = diff;
                        bestMatch = opt.value;
                    }
                });

                select.value = bestMatch;

                // ÂêåÊ≠•ÊèêÁ§∫ËØçÂíåÂÖâÊ†áÂü∫ÂáÜÈ´òÂ∫¶
                editor.style.setProperty('--placeholder-size', computedSize);
                
                // Â¶ÇÊûúÊ≠§Êó∂ÁºñËæëÂô®Ë¢´Âà†Á©∫‰∫ÜÔºåÁ°Æ‰øùÂÖâÊ†áÁª¥ÊåÅÂú®ÊúÄÂêéÈÄâ‰∏≠ÁöÑÂ§ßÂ∞è
                if (editor.innerText.trim() === "" || editor.innerText === "\n") {
                    editor.style.fontSize = computedSize;
                }
            }
        }

        /* Âü∫Á°ÄÂäüËÉΩ (‰øùÊåÅÁ®≥ÂÆö) */
        function applyFormat(cmd) { document.execCommand(cmd, false, null); document.getElementById('editor').focus(); }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('authContainer').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                db.ref(`users/${user.uid}/notes`).on('value', snap => renderNotes(snap.val()));
            } else {
                currentUser = null;
                document.getElementById('authContainer').classList.remove('hidden');
                document.getElementById('appContainer').classList.add('hidden');
            }
        });

        function handleAuth() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            if (isSignUpMode) auth.createUserWithEmailAndPassword(e, p);
            else auth.signInWithEmailAndPassword(e, p);
        }

        function toggleAuthMode() {
            isSignUpMode = !isSignUpMode;
            document.getElementById('authTitle').innerText = isSignUpMode ? "Sign Up" : "Sign In";
        }

        function saveNote() {
            const editor = document.getElementById('editor');
            const content = editor.innerHTML;
            if (!editor.innerText.trim()) return;
            db.ref(`users/${currentUser.uid}/notes/${Date.now()}`).set({
                content: content,
                lastEditedAt: new Date().toLocaleString()
            });
            editor.innerHTML = "";
            editor.style.fontSize = "16px"; // ÈáçÁΩÆÂõû M
        }

        function renderNotes(data) {
            const list = document.getElementById('notesList');
            list.innerHTML = '';
            if (!data) return;
            Object.values(data).reverse().forEach(note => {
                list.innerHTML += `<div class="note-card">
                    <div style="font-size:10px; color:#999">${note.lastEditedAt}</div>
                    <div style="margin-top:5px">${note.content}</div>
                </div>`;
            });
        }

        function togglePasswordVisibility() {
            const p = document.getElementById('password');
            p.type = p.type === 'password' ? 'text' : 'password';
        }
    </script>
</body>
</html>
